# Production Docker Compose for PII Analyzer
# Always-on architecture with web-based control panel
#
# Optimized for 128GB RAM / 32-core systems
#
# Architecture:
#   - 8x Tika containers for document extraction
#   - 1x Unified PII Analyzer + Dashboard container
#
# Resource Allocation:
#   - 8x Tika containers: 32GB total (4GB each)
#   - PII Analyzer/Dashboard: 80GB RAM, 28 CPUs
#   - OS/Overhead: ~16GB reserved
#
# Usage:
#   docker compose -f docker-compose.prod.yml up -d
#   
# Access dashboard at: http://localhost:8080

version: '3.8'

x-tika-common: &tika-common
  image: apache/tika:2.9.1.0
  restart: unless-stopped
  networks:
    - pii-network
  healthcheck:
    # Use /dev/tcp to check if port is open (works without curl/wget)
    test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/9998' || exit 1"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 90s
  deploy:
    resources:
      limits:
        cpus: '2'
        memory: 4G
      reservations:
        cpus: '1'
        memory: 2G

services:
  # ============================================================
  # Apache Tika Cluster (8 instances for document extraction)
  # ============================================================
  tika1:
    <<: *tika-common
    container_name: pii-tika-1
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika2:
    <<: *tika-common
    container_name: pii-tika-2
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika3:
    <<: *tika-common
    container_name: pii-tika-3
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika4:
    <<: *tika-common
    container_name: pii-tika-4
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika5:
    <<: *tika-common
    container_name: pii-tika-5
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika6:
    <<: *tika-common
    container_name: pii-tika-6
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika7:
    <<: *tika-common
    container_name: pii-tika-7
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  tika8:
    <<: *tika-common
    container_name: pii-tika-8
    environment:
      - JAVA_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200

  # ============================================================
  # Unified PII Analyzer + Dashboard
  # Always-on service with web-based control panel
  # ============================================================
  pii-analyzer:
    build:
      context: .
      dockerfile: Dockerfile.unified
    container_name: pii-analyzer
    # Run as root to ensure access to NFS mounts
    user: root
    restart: unless-stopped
    depends_on:
      tika1:
        condition: service_healthy
      tika2:
        condition: service_healthy
      tika3:
        condition: service_healthy
      tika4:
        condition: service_healthy
      tika5:
        condition: service_healthy
      tika6:
        condition: service_healthy
      tika7:
        condition: service_healthy
      tika8:
        condition: service_healthy
    networks:
      - pii-network
    ports:
      - "8080:8080"
    volumes:
      # Data directory (read-only for safety)
      - /data:/data:ro
      # Database persistence (read-write)
      - ./db:/app/db
      # Logs persistence
      - ./logs:/app/logs
    environment:
      # Tika cluster endpoints
      - TIKA_SERVER_ENDPOINTS=http://tika1:9998,http://tika2:9998,http://tika3:9998,http://tika4:9998,http://tika5:9998,http://tika6:9998,http://tika7:9998,http://tika8:9998
      - USE_TIKA_LOAD_BALANCER=true
      # Database location
      - PII_DB_PATH=/app/db/pii_results.db
      # Data path for analysis
      - PII_DATA_PATH=/data
      # Processing settings (used when analysis is started via web UI)
      # Optimized for heavy OCR workloads (scanned PDFs) on 32-core system
      # Reduced workers to prevent CPU overload during intensive OCR
      - PII_WORKERS=16
      - PII_BATCH_SIZE=50
      # OCR settings - 1 thread per worker, no page limit (process all pages)
      # 5 minute timeout per file allows large scanned PDFs to complete
      - OCR_THREADS=1
      - MAX_PAGES=0
      - PII_THRESHOLD=0.7
      - PII_FILE_SIZE_LIMIT=100
      # OCR settings
      - OCR_DPI=300
      - OCR_THREADS=2
      # Flask settings
      - FLASK_ENV=production
      # Performance tuning
      - PYTHONOPTIMIZE=1
    deploy:
      resources:
        limits:
          cpus: '28'
          memory: 80G
        reservations:
          cpus: '16'
          memory: 32G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    # Run the unified dashboard which includes the analysis service
    command: >
      python /app/dashboard/app.py
      --port 8080
      --db-path /app/db/pii_results.db

networks:
  pii-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  pii-db:
    driver: local
  pii-logs:
    driver: local
